---
title: "Heath and Economic Effects of Severe Weather"
author: "Aditya Taunk"
date: '2017-06-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

## Synopsis


## Data Processing

Download data if it's not found in working directory
```{r}
if(!file.exists("StormData.csv.bz2")){
  download.file(
    "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2",
    "StormData.csv.bz2"
  )
}
```

Read it into memory
```{r}
library(data.table)
data <- fread(
  "bzcat StormData.csv.bz2",
  na.strings = ""
)
```

We are interested in the data broken down by event types
```{r}
evtypes <- data[ , 
  list(
    frequency = .N,
    injuries = sum(INJURIES), 
    fatalities = sum(FATALITIES),
    property.damage = sum(PROPDMG),
    crop.damage = sum(CROPDMG)
  ),
  by = EVTYPE
]
```



### Harm

Create a column which indicates how much harm a particular event type has caused.
Here harm is defined as the sum of the fractions of injuries, fatalities, property 
and crop damage the event type has caused.
```{r}
totals <- evtypes[,
  list(
    injuries = sum(injuries),
    fatalities = sum(fatalities),
    property.damage = sum(property.damage),
    crop.damage = sum(crop.damage)
  )
]
evtypes[,
  harm := 
    injuries/totals$injuries +
    fatalities/totals$fatalities +
    property.damage/totals$property.damage +
    crop.damage/totals$crop.damage
]
```

Sort event types by amount of harm and rank them by the type of harm
```{r}
evtypes <-evtypes[order(-harm)]
evranks <- evtypes[,
  list(
    EVTYPE,
    injuries = rank(-injuries, ties.method="first"),
    fatalities = rank(-fatalities, ties.method="first"),
    property.damage = rank(-property.damage, ties.method="first"),
    crop.damage = rank(-crop.damage, ties.method="first")
  )
]
```

Lets see the top 21 most harmful events. Why 21? because they contain the top 10
causes for each of the harm types.
```{r}
head(evranks, 21)
```

As seen from the above table, tornados are the leading cause of injuries, fatalities 
and property damage. They are also a significant cause of crop damage. Also interesting
to note is that event types like heat seem hazardous to health but not so much for
property and crops. Conversely, things like hail and thunderstorm winds affect crop
and property but they affect heath to a lesser extent.

The harm value is a made up value to find the most relavant EVTYPEs. We don't need 
it anymore.
```{r}
evtypes <- evtypes[, !"harm"]
```

We want to know what percent of the total harm do these 21 account for
```{r}
toptypes <- head(evtypes, 21)
toptypes[,
  list(
    injuries = sum(injuries)/totals$injuries,
    fatalities = sum(fatalities)/totals$fatalities,
    property.damage = sum(property.damage)/totals$property.damage,
    crop.damage = sum(crop.damage)/totals$crop.damage
  )
]
```

So our subset accounts for a majority of the harm reported in the data (at least 
86%). So now we will mostly focus on those 21 EVTYPEs. We will add a row to the 
subset summing up the contributions from the other EVTYPEs.
```{r}
others <- evtypes[!EVTYPE %in% toptypes$EVTYPE,]
otherstotal <- others[,
  list(
    EVTYPE = "OTHER",
    frequency = sum(frequency),
    injuries = sum(injuries),
    fatalities = sum(fatalities),
    property.damage = sum(property.damage),
    crop.damage = sum(crop.damage)
  )
]
evtypes <- rbind(toptypes,otherstotal)
options(width = 120)
evtypes
```

Here is a plot of the above data separated by the type of harm
```{r}
par(mar=c(2,3,2,1))
layout(matrix(c(1,2,5,3,4,5),2,3,byrow=T))
library(colorRamps)
cols <- primary.colors(22)

with(evtypes, barplot(injuries+1, main="Injuries", log="y", yaxt="n", col=cols))
axis(2, at=c(6,51,501,5001,50001), label=c(5,50,500,5000,50000))

with(evtypes, barplot(fatalities+1, main="Fatalities", log="y", yaxt="n", col=cols))
axis(2, at=c(1,6,51,501,5001), label=c(0,5,50,500,5000))

with(evtypes, barplot(property.damage+1, main="Property Damage ($)", yaxt="n", log="y", col=cols))
axis(2, at=c(6,51,501,10001,1000001), label=c(5,50,500,1e4,1000000))

with(evtypes, barplot(crop.damage+1, main="Crop Damage ($)", log="y", yaxt="n", col=cols))
axis(2, at=c(1,6,51,501,10001,500001), label=c(0,5,50,500,1e4,500000))

plot(1, 1, type="n", ann=FALSE, yaxt='n', xaxt='n')
legend("center", evtypes$EVTYPE, fill=cols, box.lwd=0)
```

### Tornadoes

As seen before, tornadoes are the leading cause for three of the four harm types.
So lets examine them more closely. 
```{r}
tornadoes <- data[EVTYPE == "TORNADO",]
```

Here are tornadoes' contribution to total harm
```{r}
tornadoes[,
  list(
    injuries = sum(INJURIES)/totals$injuries,
    fatalities = sum(FATALITIES)/totals$fatalities,
    property.damage = sum(PROPDMG)/totals$property.damage,
    crop.damage = sum(CROPDMG)/totals$crop.damage
  )
]
```

Note that the majority of injuries due to severe weather are caused by tornadoes.

Here is a breakdown of injuries by the fujita scale. 
```{r}
fujita.breakdown <- tornadoes[
  order(F),
  list(
    frequency = .N,
    injuries = sum(INJURIES),
    injuries.per.tornado = sum(INJURIES)/.N,
    factor.of.total = sum(INJURIES)/evtypes[EVTYPE=="TORNADO",injuries]
  ),
  by = F
]
fujita.breakdown
```

Unsurprisingly, milder tornadoes are more frequent and severe tornadoes cause more
injuries per tornado on avergae. Note that tornadoes with F-scale 4 cause the most
number of injuries in total (33616) accounting for more than 36% of all injuries
due to tornadoes.

Let's see where these tornado's are located
```{r}
par(mar=c(1,1,2.5,1))
with(
  tornadoes, 
  smoothScatter(
    -LONGITUDE, LATITUDE, 
    xlim=c(-12600,-6500), ylim=c(2300,5200),
    xaxt='n', yaxt='n',
    xlab='', ylab='',
    main="Locations of Tornadoes"
  )
)
```

You can clearly see the shape of the Continental USA from the plot above which shows
the locations of the tornadoes reported in the data. For some reason most of the
tornadoes are in the Eastern half of the country.

### Trends

We want to find out how things have changed over time. And again we want to look 
at only the top 21 EVTYPEs.
```{r}
dates <-  as.Date(data$BGN_DATE, format="%m/%d/%Y")
data[, year := as.integer(format(dates, format="%Y"))]
evtypesbyyear <- rbind(
  data[
    EVTYPE %in% toptypes$EVTYPE,
    list(
      injuries = sum(INJURIES),
      fatalities = sum(FATALITIES),
      property.damage = sum(PROPDMG),
      crop.damage = sum(CROPDMG)
    ),
    by = .(EVTYPE, year)
  ],
  data[
    !EVTYPE %in% toptypes$EVTYPE,
    list(
      EVTYPE = "OTHER",
      injuries = sum(INJURIES),
      fatalities = sum(FATALITIES),
      property.damage = sum(PROPDMG),
      crop.damage = sum(CROPDMG)
    ),
    by = year
  ]
)
evtypesbyyear[order(year, match(EVTYPE, evtypes$EVTYPE))]
```

This plot shows the evolution of EVTYPEs over the years
```{r}

library(ggplot2)

```



## Results





